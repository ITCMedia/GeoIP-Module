<!-- ////////////  ПРИНЦИП ФОРМИРОВАНИЯ МЕТЫ   //////////// -->
<!-- 
Исходная мета: 
Тайтл: Окна ПВХ (пластиковые) в Брянске по выгодным ценам :: Сайт оконной компании
Деск: Качественные пластиковые окна в Брянске по доступным ценам от компании Сайт оконной компании. Звоните по телефону  +7 (4832) 11-22-33.
Ключи: окна пвх в брянске цены, пластиковые окна брянск, окна пластиковые, окна пвх,купить окна, окна пвх купить, купить окна брянск, монтаж окон брянск

Ключевые слова:
*Город* - Брянск 
*Городе* - Брянске
*Города* - Брянска

Мета для сайта: 
Тайтл: Окна ПВХ (пластиковые) в *Городе* по выгодным ценам :: Сайт оконной компании
Деск: Качественные пластиковые окна в *Городе* по доступным ценам от компании Сайт оконной компании. Звоните по телефону  +7 (4832) 11-22-33.
Ключи: окна пвх в *Городе* цены, пластиковые окна *Город*, окна пластиковые, окна пвх,купить окна, окна пвх купить, заказать окно в *Городе*, купить окна *Город*, монтаж окон *Города*
-->


<!-- ////////////  ПОДКЛЮЧЕНИЕ   //////////// -->

<!-- 0) Залить в корневую директорию на сервер папку geoip со всем ее содержимым. Список нужных для модального окна городов необходимо отредактировать в файле modal_include.php -->

<!-- 
	1) В корневой директории найти файл bootstrap.php 
	Найти в нем строчку кода Core::init(); и сразу после нее объявить следующий код (без скобок <? ?>):
-->
<?
require_once $_SERVER['DOCUMENT_ROOT'].'/geoip/geo_module.php';
?>

<!-- Далее, в макете, шаблоне, ТДС или структуре, где планируется использовать данные с модуля, необходимо вставить следующий код:  -->

<? 
if(isset($_COOKIE['current_city'])) $city_name = $_COOKIE['current_city'];
if(isset($_COOKIE['current_city_r'])) $city_nameR = $_COOKIE['current_city_r'];
if(isset($_COOKIE['current_city_p'])) $city_nameP = $_COOKIE['current_city_p'];
?>

<!-- 2) В Макете сайта, где выводится мета-информация, заменить стандартную и указать ту, что ниже (включая функцию putRelCanonical()) -->

<title><?php keyReplace(Core_Page::instance()->title, $city_nameP, $city_nameR, $city_name); ?></title>
<meta name="description" content="<?php keyReplace(Core_Page::instance()->description, $city_nameP, $city_nameR, $city_name); ?>" />
<meta name="keywords" content="<?php keyReplace(Core_Page::instance()->keywords, $city_nameP, $city_nameR, $city_name); ?>" />
<?php putRelCanonical($city_name); ?>

<!-- 3) Прописываем отображение текущего города в span.b-geo__city-name_header. !Важно - этот класс необходимо сохранять, т.к он работает для поднятия модального окна -->
Текущий город: <span class="b-geo__city-name_header"><?=$city_name;?></span>

<!-- 4) В футере сайта после всех скриптов прописать данную строку, которая отвечает за вызов модального окна со списком городов. -->
<? include_once $_SERVER['DOCUMENT_ROOT'].'/geoip/modal_include.php'; ?>

<!-- 5) После того, как текущий город установлен в переменные, необходимо сделать проверку для контактных данных и прочего -->
<? if($city_name == "Москва"):?>
<!-- HTML-код для вывода информации о Москве -->
<? elseif($city_name == "Брянск"):?>
<!-- HTML-код для вывода информации о Брянске -->
<?else:?>
<!-- HTML-код для вывода информации, если регион пользователя не принадлежит никакому региону из списка -->
<? endif;?>

<!-- ////////////  ДИНАМИЧЕСКИЕ СИСТЕМЫ   //////////// -->

<!-- Для того, чтобы добавить GeoIP в динамические системы, в настройках ТДС необходимо объявить модуль: -->
<?
if(isset($_COOKIE['current_city'])) $city_name = $_COOKIE['current_city'];
if(isset($_COOKIE['current_city_r'])) $city_nameR = $_COOKIE['current_city_r'];
if(isset($_COOKIE['current_city_p'])) $city_nameP = $_COOKIE['current_city_p'];
?> 

<!-- Далее необходимо найти строку -->
<? 
$Shop_Controller_Show = new Shop_Controller_Show($oShop); 
?>

<!-- 
И сразу после нее внести следующий код, который будет добавлять в генерируемый XML сущность с передачей текущего города
!!! Важно: Для ИС, соответственно, заменить все на Informationsystem
-->
<?
$Shop_Controller_Show->addEntity(
	Core::factory('Core_Xml_Entity')
	->name('city_name')->value($city_name)
);
$Shop_Controller_Show->addEntity(
	Core::factory('Core_Xml_Entity')
	->name('city_nameR')->value($city_nameR)
);
$Shop_Controller_Show->addEntity(
	Core::factory('Core_Xml_Entity')
	->name('city_nameP')->value($city_nameP)
);
?>

<!-- 
Для обновления генерации мета-информации надо заменить код генерации из файла meta_view.php 
Чистая мета находится в файле clear_meta_view.php
-->


<!-- Далее, при работе с XSL у нас имеется сущность city_name, родитель которой непосредственно shop (это надо учитывать при формировании проверок, чтобы указывать верный путь к переменной) -->
<xsl:value-of select=".//city_name" />

<!-- Соответственно, проверка будет выглядеть вот так (путь в зависимости от уровня вложенности) -->
<xsl:if test=".//city_name != ''">
	<xsl:value-of select=".//city_name" />
	<xsl:value-of select=".//city_nameR" />
	<xsl:value-of select=".//city_nameP" />
</xsl:if>

<xsl:if test=".//city_name != '' and .//city_name = 'Москва'">
	Выводим контент для Москвы
</xsl:if>

<!-- Либо вот так -->
<xsl:choose>
	<xsl:when test=".//city_name = 'Москва'">
		Выводим контент для Москвы
	</xsl:when>
	<xsl:when test=".//city_name = 'Брянск'">
		Выводим контент для Брянска
	</xsl:when>
	<xsl:otherwise>
		Выводим базовый контент
	</xsl:otherwise>
</xsl:choose>

<!-- ////////////  ФОРМЫ   //////////// -->

<!-- Для передачи текущего города пользователя в форму надо добавить следующий код:  -->
<input type="hidden" name="geoip_city" value="<?=$city_name;?>">

<!-- А в обработчик PHP добавить к другим полям при выводе: -->
<?
if($key == 'geoip_city') {
	$body .= "Город пользователя: ";
	$body .= addslashes($value);
	$body .= "\n<br>";
}	
?>

<!-- Для смены почты получателя в зависимости от региона, необходимо изменить функцию mail() и добавить следующее -->
<?
	if (isset($_POST['geoip_city'])) {
		if($_POST['geoip_city'] == 'Брянск'){
			$receiver = "mail@site.ru"; // Почта для Брянска
		}elseif($_POST['geoip_city'] == 'Москва'){
			$receiver = "mail@site.ru"; // Почта для Москвы
		}else{
			$receiver = "mail@site.ru"; // Почта по-умолчанию всех других городов
		}
	} else {
		$receiver = "mail@site.ru";	// Почта по-умолчанию, если город не был получен
	}
	
	mail($receiver, 'Заголовок письма', $messageRec, $headersRec); 
?>

<!-- ////////////  КАРТЫ САЙТА   //////////// -->

<!-- 
Для модификации карты сайта необходимо объявить подключаемый файл модуля в Типовой динамической странице Google SiteMap.
Далее после строки 
-->
<? $oSite_Alias = $oSite->getCurrentAlias(); ?>
<!-- Необходимо прописать проверку на поддомен -->
<?
if(getSubDomain($_SERVER['HTTP_HOST'], -3) != ''){ // Учесть уровень домена
	$oSite->getCurrentAlias()->name = getSubDomain($_SERVER['HTTP_HOST'], -3) . '.' . $oSite->getCurrentAlias()->name; // Учесть уровень домена
}
?>
<!-- 
Которая проверяет, что, если у нас существует поддомен, то с помощью функции getSubDomain() мы выделим поддомен и допишем этот поддомен в карту сайта 
-->


<!-- ////////////  ROBOTS.TXT   //////////// -->

<!-- 
Основной robots.txt редактируется в админ.панели CMS. 
robots.txt для регионов необходимо разместить в папке, соответствующей названию домена и его настраивать для конкретного региона.
Затем необходимо редактировать .htaccess и внести внего проверку на домен. Если домен такой то, то настраиваем редирект файла robots.txt 
!!! Важно: размещение кода редиректа файла необходимо ставить выше стандартных правил в блоке <IfModule mod_rewrite.c>
-->
<IfModule mod_rewrite.c>
	RewriteEngine On
	RewriteBase /
	
	# Редирект роботса для домена bryansk.your.domain.ru
	RewriteCond %{HTTP_HOST} bryansk.your.domain.ru [NC]
	RewriteRule ^robots.txt /bryansk/robots.txt [L]

	# Дальнейший код в этом блоке 
</IfModule>


<!-- ////////////  ОТКЛЮЧЕНИЕ ГЕО-ПРИВЯЗКИ В МЕТЕ   //////////// -->

<!-- Для того, чтобы указать страницы, на которых необходимо отключить отображение мета-информации с гео-привязкой, в файл links.txt в корне сайта нужно прописать список ссылок. 1 ссылка без слешей на 1 строке. 
Проверка также учитывает вложенные динамические страницы, например, все динамически новости в разделе /news/. Функция также учитывает данные ссылки для отключения показа rel="canonical" Пример ссылок -->
otzyvy
kontakty
about/news


<!-- ////////////  ДОБАВЛЕНИЕ WWW   //////////// -->
<!-- Для проекта с использование www в домене, необходимо использовать код из файла geo_module_w.php -->