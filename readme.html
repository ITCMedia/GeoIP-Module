<!-- ////////////  ПОДКЛЮЧЕНИЕ   //////////// -->

<!-- 1) Объявляем модуль в шапке основного макета -->
<?
require $_SERVER['DOCUMENT_ROOT'].'/geo_module.php';
?>

<!-- ........ -->

<?
if (Core::moduleIsActive('shop') && isset(Core_Page::instance()->libParams['shopId'])) { // Проверка меты для магазина
?>
	<title><?php Core_Page::instance()->showTitle();?></title>
	<meta name="description" content="<?php Core_Page::instance()->showDescription();?>" />
	<meta name="keywords" content="<?php Core_Page::instance()->showKeywords()?>" />
<?
} else if(Core::moduleIsActive('informationsystem') && isset(Core_Page::instance()->libParams['informationsystemId'])) {  // Проверка меты для ИС
?>
	<title><?php Core_Page::instance()->showTitle();?></title>
	<meta name="description" content="<?php Core_Page::instance()->showDescription();?>" />
	<meta name="keywords" content="<?php Core_Page::instance()->showKeywords()?>" />
<?
} else {  // Проверка меты для статики
?>
	<title><?php Core_Page::instance()->showTitle(); echo ' ' . $prePhrase['phrase1'] . ' ' . $city_nameP; ?></title>
	<meta name="description" content="<?php Core_Page::instance()->showDescription(); echo ' ' . $prePhrase['phrase1'] . ' ' . $city_nameP; ?>" />
	<meta name="keywords" content="<?php Core_Page::instance()->showKeywords();  echo ' ' . $prePhrase['phrase1'] . ' ' . $city_nameP; ?>" />
<?
}
?>

<!-- 2) Ставим проверку на выпадающий список с городами. Если это select, то оборачиваем его в form. Action выполняется на текущей странице -->
<form action="./" method="POST">
	<select size="1" name="city_choose" onchange="$(this).parent('form').submit();">
		<option selected value="Брянск">Брянск</option>
		<option value="Москва">Москва</option>
	</select>
</form>

<!-- 3) Далее определяется текущий город пользователя:  -->
<?
	if (isset($_SESSION['current_city'])){
		echo $_SESSION['current_city']; // Показываваем город из сессии
		$city_name = $_SESSION['current_city'];
	}else{
		if (!is_null($oGeoData))
		{
			echo $city_name;// Показываваем город из GeoIP
		}else{
			$_SESSION['current_city'] = 'Брянск'; // Задаем сами, если город не обнаружен
			$city_name = 'Брянск';
			echo 'Брянск';
		}
	}
?>

<!-- 
4) Если город выбран из списка, то он заносится в переменную из сессии, если сессия пуста - определяется GeoIP и заносится в переменную. Если и оно не дало результатов, то город поумолчанию - Брянск.
Пример с проекта Адаптика: 
-->
<select size="1" name="city_choose" onchange="$(this).parent('form').submit();">
	<?
		if (isset($_SESSION['current_city'])){
			echo $_SESSION['current_city'];
			$city_name = $_SESSION['current_city'];
			echo "<option selected value='$city_name'>Текущий город: $city_name</option>";
		}else{
			if (!is_null($oGeoData))
			{
				echo $city_name;
				echo "<option selected value='$city_name'>Текущий город: $city_name</option>";
			}else{
				$_SESSION['current_city'] = 'Брянск';
				$city_name = 'Брянск';
				echo "<option selected value='Брянск'>Текущий город: Брянск</option>";
			}
		}
	?>
	<option value="Брянск">Брянск</option>
	<option value="Москва">Москва</option>
</select>

<!-- 5) После того, как текущий город установлен в переменные, необходимо сделать проверку для контактных данных: -->
<?
	if($city_name == "Брянск"){
?>
<!-- HTML-код для вывода информации о Брянске -->
<?
	} elseif($city_name == "Москва"){ 
?>
<!-- HTML-код для вывода информации о Москве -->
<?
	}
?>


<!-- ////////////  ДИНАМИЧЕСКИЕ СИСТЕМЫ   //////////// -->

<!-- Для того, чтобы добавить GeoIP в динамические системы, в настройках ТДС необходимо объявить модуль: -->
<?
require $_SERVER['DOCUMENT_ROOT'].'/geo_module.php';
?> 

<!-- Далее необходимо найти строку -->
<? $Shop_Controller_Show = new Shop_Controller_Show($oShop); ?>

<!-- 
И сразу после нее внести следующий код, который будет добавлять в генерируемый XML сущность с передачей текущего города
!!! Важно: Для ИС, соответственно, заменить все на Informationsystem
-->
<?
$Shop_Controller_Show->addEntity(
	Core::factory('Core_Xml_Entity')
	->name('city_name')->value($city_name)
);
$Shop_Controller_Show->addEntity(
	Core::factory('Core_Xml_Entity')
	->name('city_nameR')->value($city_nameR)
);
$Shop_Controller_Show->addEntity(
	Core::factory('Core_Xml_Entity')
	->name('city_nameP')->value($city_nameP)
);
?>

<!-- 
Для обновления генерации мета-информации надо заменить код генерации из файла meta_view.php 
Чистая мета находится в файле clear_meta_view.php
Мета для конкретной Информационной системы, например, Акции, находится в файле meta_view_current_IS.php. Тут необходимо будет указать требуемый ID ИС
-->

<!-- Далее, при работе с XSL у нас имеется сущность city_name, родитель которой непосредственно shop (это надо учитывать при формировании проверок, чтобы указывать верный путь к переменной) -->
<xsl:value-of select=".//city_name" />

<!-- Соответственно, проверка будет выглядеть вот так (путь в зависимости от уровня вложенности) -->
<xsl:if test=".//city_name != ''">
	<xsl:value-of select=".//city_name" />
	<xsl:value-of select=".//city_nameR" />
	<xsl:value-of select=".//city_nameP" />
</xsl:if>

<xsl:if test=".//city_name != '' and .//city_name = 'Москва'">
	Выводим контент для Москвы
</xsl:if>

<!-- Либо вот так -->
<xsl:choose>
	<xsl:when test=".//city_name = 'Москва'">
		Выводим контент для Москвы
	</xsl:when>
	<xsl:when test=".//city_name = 'Брянск'">
		Выводим контент для Брянска
	</xsl:when>
	<xsl:otherwise>
		Выводим базовый контент
	</xsl:otherwise>
</xsl:choose>

<!-- ////////////  ФОРМЫ   //////////// -->

<!-- Для передачи текущего города пользователя в форму надо добавить следующий код:  -->
<input type="hidden" name="geoip_city" value="<?=$city_name;?>">

<!-- А в обработчик PHP добавить к другим полям при выводе: -->
<?
if($key == 'geoip_city') {
	$body .= "Город пользователя: ";
	$body .= htmlspecialchars($value);
	$body .= "\n<br>";
}	
?>

<!-- Для смены в зависимости от региона, необходимо изменить функцию mail() и добавить следующее -->
<?
	if (isset($_POST['geoip_city'])) {
		if($_POST['geoip_city'] == 'Брянск'){
			$receiver = "mail@site.ru"; // Почта для Брянска
		}elseif($_POST['geoip_city'] == 'Москва'){
			$receiver = "mail@site.ru"; // Почта для Москвы
		}else{
			$receiver = "mail@site.ru"; // Почта по-умолчанию всех других городов
		}
	} else {
		$receiver = "mail@site.ru";	// Почта по-умолчанию, если город не был получен
	}
	
	mail($receiver, 'Заголовок письма', $messageRec, $headersRec); 
?>

<!-- ////////////  КАРТЫ САЙТА   //////////// -->

<!-- 
Для модификации карты сайта необходимо объявить подключаемый файл модуля в Типовой динамической странице Google SiteMap.
Далее после строки 
-->
<? $oSite_Alias = $oSite->getCurrentAlias(); ?>
<!-- Необходимо прописать проверку на поддомен -->
<?
if(getSubDomain($_SERVER['HTTP_HOST'], -3) == "bryansk"){ // Уровень вложенности зависит от уровня домена
	$oSite->getCurrentAlias()->name = 'bryansk.' . $oSite->getCurrentAlias()->name;
}
?>
<!-- 
Которая проверяет, что, если у нас адрес сайта - http://bryansk.site.tmweb.ru, то с помощью функции getSubDomain() мы выделим поддомен и если поддомен соответствует нами проверенному, то дописываем этот поддомен в карту сайта 
-->


<!-- ////////////  ROBOTS.TXT   //////////// -->

<!-- 
Основной robots.txt редактируется в админ.панели CMS. 
robots.txt для регионов необходимо разместить в папке, соответствующей названию домена и его настраивать для конкретного региона.
Затем необходимо редактировать .htaccess и внести внего проверку на домен. Если домен такой то, то настраиваем редирект файла robots.txt 
!!! Важно: размещение кода редиректа файла необходимо ставить выше стандартных правил в блоке <IfModule mod_rewrite.c>
-->
<IfModule mod_rewrite.c>
	RewriteEngine On
	RewriteBase /
	
	# Редирект роботса для домена bryansk.adaptika.tmweb.ru
	RewriteCond %{HTTP_HOST} bryansk.adaptika.tmweb.ru [NC]
	RewriteRule ^robots.txt /bryansk/robots.txt [L]

	RewriteCond %{REQUEST_FILENAME} !-f
	RewriteCond %{REQUEST_FILENAME} !-d
	RewriteRule ^(.*)$ /index.php

</IfModule>